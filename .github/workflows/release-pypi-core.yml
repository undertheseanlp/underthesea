on:
  push:
    branches: [ core ]

jobs:
  linux-build-pypi-publish:
    name: "Build on Linux"
    if: "contains(github.event.head_commit.message, 'Publish Underthesea Core')"
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/undertheseanlp/underthesea/build_rust:1.0.0
    env:
      HOME: /root
      PYTHON: python${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
    steps:
      - uses: actions/checkout@v1
      - name: Show environments
        run: |
          cargo --version
          $PYTHON -m poetry --version
      - name: poetry install dependencies
        working-directory: ./extensions/underthesea_core
        env:
          LC_ALL: en_US.UTF-8  # known issue: https://github.com/python-poetry/poetry/issues/221#issuecomment-723652470
        run: |
          $PYTHON -m poetry install
          $PYTHON -m poetry show
      - name: Build Python package
        working-directory: ./extensions/underthesea_core
        run: $PYTHON -m poetry run maturin build --release --no-sdist --strip --interpreter python${{ matrix.python-version }}
      - name: List wheels
        working-directory: ./extensions/underthesea_core
        run: find ./target/wheels/
      - name: PyPi publish
        working-directory: ./extensions/underthesea_core
        env:
          MATURIN_PASSWORD: ${{ secrets.PYPI_UNDERTHESEA_CORE_API_TOKEN }}
        run: $PYTHON -m poetry run maturin publish --username __token__ --no-sdist --interpreter python${{ matrix.python-version }}
  macos-windows-build-pypi-publish:
    name: "Build MacOS & Windows"
    if: "contains(github.event.head_commit.message, 'Publish Underthesea Core')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
        os: [macos-latest, macos-13, windows-latest]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install latest nightly
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        override: true
    - name: Install pip and poetry (MacOS)
      working-directory: ./extensions/underthesea_core
      if:  matrix.os != 'windows-latest'
      run: | 
        python -m pip install --upgrade pip
        mkdir "${HOME}/poetry"
        curl -sSL https://install.python-poetry.org | POETRY_HOME=${HOME}/poetry python -
        echo "${HOME}/poetry/bin" >> $GITHUB_PATH

    - name: Install pip and poetry (Windows)
      if:  matrix.os == 'windows-latest'
      run: | 
        python -m pip install --upgrade pip
        mkdir "${HOME}/poetry"
        curl -sSL https://install.python-poetry.org | python -
        echo "C:\Users\runneradmin\AppData\Roaming\Python\Scripts\" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install package deps
      working-directory: ./extensions/underthesea_core
      run: |
        poetry install

    - name: Build Python package
      if:  matrix.os == 'windows-latest'
      working-directory: ./extensions/underthesea_core
      run: poetry run maturin build --release --no-sdist --strip --interpreter python
    - name: Build Python package
      if:  matrix.os != 'windows-latest'
      working-directory: ./extensions/underthesea_core
      run: poetry run maturin build --release --no-sdist --strip --interpreter python${{ matrix.python-version }}

    - name: List wheels
      if:  matrix.os != 'windows-latest'
      working-directory: ./extensions/underthesea_core
      run: find ./target/wheels/
    - name: List wheels
      if:  matrix.os == 'windows-latest'
      working-directory: ./extensions/underthesea_core
      run: dir target\wheels\

    - name: Install wheels
      if:  matrix.os != 'windows-latest'
      working-directory: ./extensions/underthesea_core
      run: pip install target/wheels/underthesea_core*.whl

    - name: PyPi publish
      if:  matrix.os != 'windows-latest'
      working-directory: ./extensions/underthesea_core
      env:
        MATURIN_PASSWORD: ${{ secrets.PYPI_UNDERTHESEA_CORE_API_TOKEN }}
      run: poetry run maturin publish --username __token__ --no-sdist --interpreter python${{ matrix.python-version }}
    - name: PyPi publish
      if: matrix.os == 'windows-latest'
      working-directory: ./extensions/underthesea_core
      env:
        MATURIN_PASSWORD: ${{ secrets.PYPI_UNDERTHESEA_CORE_API_TOKEN }}
      run: poetry run maturin publish --username __token__ --no-sdist --interpreter python

  macos-arm-build-pypi-publish:
    name: "Build MacOS ARM"
    if: "contains(github.event.head_commit.message, 'Publish Underthesea Core')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
        os: [macos-arm]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install latest nightly
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        override: true
    - name: Install pip and poetry (MacOS)
      working-directory: ./extensions/underthesea_core
      run: |
        echo 'Skip install pip and poetry in self-hosted'

    - name: Install package deps
      working-directory: ./extensions/underthesea_core
      run: |
        poetry install

    - name: Build Python package
      working-directory: ./extensions/underthesea_core
      run: poetry run maturin build --release --no-sdist --strip --interpreter python${{ matrix.python-version }}

    - name: List wheels
      working-directory: ./extensions/underthesea_core
      run: find ./target/wheels/

    - name: Install wheels
      working-directory: ./extensions/underthesea_core
      run: pip install target/wheels/underthesea_core*.whl

    - name: PyPi publish
      working-directory: ./extensions/underthesea_core
      env:
        MATURIN_PASSWORD: ${{ secrets.PYPI_UNDERTHESEA_CORE_API_TOKEN }}
      run: poetry run maturin publish --username __token__ --no-sdist --interpreter python${{ matrix.python-version }}