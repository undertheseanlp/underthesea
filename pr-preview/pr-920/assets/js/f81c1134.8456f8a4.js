"use strict";(globalThis.webpackChunkunderthesea_docs=globalThis.webpackChunkunderthesea_docs||[]).push([[5749],{7735(e){e.exports=JSON.parse('{"archive":{"blogPosts":[{"id":"rewrite-rust-crf-model","metadata":{"permalink":"/blog/rewrite-rust-crf-model","editUrl":"https://github.com/undertheseanlp/underthesea/tree/main/docusaurus/blog/2026-02-02-rewrite-rust-crf-model.md","source":"@site/blog/2026-02-02-rewrite-rust-crf-model.md","title":"Rewriting CRF Model in Rust - 20% Performance Boost","description":"In underthesea v9.2.5, we completed the migration from python-crfsuite to our native Rust implementation underthesea-core. This change resulted in a 20% performance improvement across all CRF-based NLP tasks.","date":"2026-02-02T00:00:00.000Z","tags":[{"inline":true,"label":"rust","permalink":"/blog/tags/rust"},{"inline":true,"label":"performance","permalink":"/blog/tags/performance"},{"inline":true,"label":"crf","permalink":"/blog/tags/crf"},{"inline":true,"label":"nlp","permalink":"/blog/tags/nlp"}],"readingTime":2.67,"hasTruncateMarker":true,"authors":[{"name":"Vu Anh","title":"Creator of Underthesea","url":"https://github.com/rain1024","imageURL":"https://github.com/rain1024.png","key":"rain1024","page":null}],"frontMatter":{"slug":"rewrite-rust-crf-model","title":"Rewriting CRF Model in Rust - 20% Performance Boost","authors":["rain1024"],"tags":["rust","performance","crf","nlp"]},"unlisted":false},"content":"In underthesea v9.2.5, we completed the migration from `python-crfsuite` to our native Rust implementation `underthesea-core`. This change resulted in a **20% performance improvement** across all CRF-based NLP tasks.\\n\\n\x3c!-- truncate --\x3e\\n\\n## Background\\n\\nUnderthesea uses Conditional Random Fields (CRF) for several core NLP tasks:\\n- Word tokenization\\n- POS tagging\\n- Named Entity Recognition (NER)\\n- Chunking\\n\\nPreviously, we relied on `python-crfsuite`, a Python wrapper for the CRFsuite C++ library. While functional, this introduced overhead from multiple language boundaries.\\n\\n## The Architecture Change\\n\\n### Before (v9.2.1)\\n\\n```\\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\\n\u2502                        Python                                \u2502\\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\\n\u2502  \u2502    Input     \u2502\u2500\u2500\u2500\u25b6\u2502 CRFFeaturizer\u2502\u2500\u2500\u2500\u25b6\u2502   Python     \u2502  \u2502\\n\u2502  \u2502   Tokens     \u2502    \u2502    (Rust)    \u2502    \u2502    List      \u2502  \u2502\\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\\n\u2502                                                  \u2502          \u2502\\n\u2502                                                  \u25bc          \u2502\\n\u2502                                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\\n\u2502                                          \u2502  pycrfsuite  \u2502  \u2502\\n\u2502                                          \u2502    (C++)     \u2502  \u2502\\n\u2502                                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\\n```\\n\\nThe data flow crossed multiple language boundaries:\\n1. Python \u2192 Rust (CRFFeaturizer)\\n2. Rust \u2192 Python (feature list)\\n3. Python \u2192 C++ (pycrfsuite)\\n4. C++ \u2192 Python (tags)\\n\\n### After (v9.2.5)\\n\\n```\\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\\n\u2502                        Python                                \u2502\\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\\n\u2502  \u2502    Input     \u2502\u2500\u2500\u2500\u25b6\u2502 CRFFeaturizer\u2502\u2500\u2500\u2500\u25b6\u2502  CRFTagger   \u2502  \u2502\\n\u2502  \u2502   Tokens     \u2502    \u2502    (Rust)    \u2502    \u2502    (Rust)    \u2502  \u2502\\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\\n\u2502                              \u2502                   \u2502          \u2502\\n\u2502                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\\n\u2502                               underthesea-core              \u2502\\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\\n```\\n\\nNow both preprocessing and inference are in Rust within the same module, eliminating the C++ dependency entirely.\\n\\n## Code Changes\\n\\nThe change was minimal from the API perspective:\\n\\n**Before:**\\n```python\\nimport pycrfsuite\\nfrom underthesea_core import CRFFeaturizer\\n\\nclass FastCRFSequenceTagger:\\n    def load(self, base_path):\\n        estimator = pycrfsuite.Tagger()\\n        estimator.open(model_path)\\n        # ...\\n```\\n\\n**After:**\\n```python\\nfrom underthesea_core import CRFFeaturizer, CRFTagger\\n\\nclass FastCRFSequenceTagger:\\n    def load(self, base_path):\\n        estimator = CRFTagger()\\n        estimator.load(model_path)\\n        # ...\\n```\\n\\n## Benchmark Results\\n\\nWe benchmarked both versions on the same hardware with 100 iterations:\\n\\n| Function | v9.2.1 (pycrfsuite) | v9.2.5 (Rust) | Improvement |\\n|----------|---------------------|---------------|-------------|\\n| word_tokenize | 1.45ms | 1.18ms | **-19%** |\\n| pos_tag | 3.58ms | 2.93ms | **-18%** |\\n| ner | 9.61ms | 8.49ms | **-12%** |\\n| chunk | 6.19ms | 5.65ms | **-9%** |\\n\\n## Why Is It Faster?\\n\\n### 1. Unified Runtime\\n\\nBoth `CRFFeaturizer` and `CRFTagger` are now in the same Rust module. This allows:\\n- Shared memory management\\n- No intermediate Python object creation\\n- Potential for future optimizations (e.g., fusing operations)\\n\\n### 2. Optimized Viterbi Implementation\\n\\nOur Rust implementation uses pre-allocated vectors and cache-friendly memory layouts:\\n\\n```rust\\nfn viterbi(&self, attr_ids: &[Vec<u32>]) -> TaggingResult {\\n    let n = attr_ids.len();\\n    let num_labels = self.model.num_labels;\\n\\n    // Pre-allocated score matrix\\n    let mut score = vec![vec![f64::NEG_INFINITY; num_labels]; n];\\n    let mut back = vec![vec![0u32; num_labels]; n];\\n\\n    // Cache emission scores per position\\n    let emission_t = self.model.emission_scores(&attr_ids[t]);\\n\\n    // Direct memory access in inner loop\\n    for y in 0..num_labels {\\n        for y_prev in 0..num_labels {\\n            let trans = self.model.get_transition(y_prev as u32, y as u32);\\n            // ...\\n        }\\n    }\\n}\\n```\\n\\n### 3. Zero-Copy Where Possible\\n\\nPyO3 bindings allow efficient data transfer between Python and Rust without unnecessary copying.\\n\\n### 4. Removed Dependency\\n\\nRemoving `python-crfsuite` also means:\\n- Simpler installation (no C++ compiler needed)\\n- Smaller package size\\n- Fewer potential compatibility issues\\n\\n## Migration Path\\n\\nThe migration was done incrementally across 4 releases:\\n\\n| Version | Changes |\\n|---------|---------|\\n| v9.2.2 | word_tokenize migrated |\\n| v9.2.3 | pos_tag, ner, chunking migrated |\\n| v9.2.4 | CRFTrainer migrated, removed unused files |\\n| v9.2.5 | Removed python-crfsuite dependency |\\n\\n## Model Compatibility\\n\\nThe Rust implementation can load existing `.crfsuite` model files trained by python-crfsuite. No retraining is required.\\n\\n```python\\n# Works with both old and new models\\nfrom underthesea import word_tokenize\\nword_tokenize(\\"H\xe0 N\u1ed9i l\xe0 th\u1ee7 \u0111\xf4 c\u1ee7a Vi\u1ec7t Nam\\")\\n# [\'H\xe0 N\u1ed9i\', \'l\xe0\', \'th\u1ee7 \u0111\xf4\', \'c\u1ee7a\', \'Vi\u1ec7t Nam\']\\n```\\n\\n## Conclusion\\n\\nBy rewriting our CRF inference in Rust and unifying the preprocessing pipeline, we achieved:\\n\\n- **20% faster inference** across all CRF-based tasks\\n- **Simpler dependency tree** (no python-crfsuite)\\n- **Better maintainability** with a single codebase\\n\\nThe full implementation is available in [underthesea-core](https://github.com/undertheseanlp/underthesea/tree/main/extensions/underthesea_core).\\n\\n## Try It Out\\n\\n```bash\\npip install underthesea==9.2.5\\n```\\n\\n```python\\nfrom underthesea import word_tokenize, pos_tag, ner, chunk\\n\\nword_tokenize(\\"Vi\u1ec7t Nam\\")  # 20% faster!\\n```"}]}}')}}]);