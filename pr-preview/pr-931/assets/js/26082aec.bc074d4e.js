"use strict";(globalThis.webpackChunkunderthesea_docs=globalThis.webpackChunkunderthesea_docs||[]).push([[3388],{2413(e){e.exports=JSON.parse('{"permalink":"/blog/rewrite-rust-crf-model","editUrl":"https://github.com/undertheseanlp/underthesea/tree/main/docusaurus/blog/2026-02-02-rewrite-rust-crf-model.md","source":"@site/blog/2026-02-02-rewrite-rust-crf-model.md","title":"Rewriting CRF Model in Rust - 20% Performance Boost","description":"In underthesea v9.2.5, we completed the migration from python-crfsuite to our native Rust implementation underthesea-core. This change resulted in a 20% performance improvement across all CRF-based NLP tasks.","date":"2026-02-02T00:00:00.000Z","tags":[{"inline":true,"label":"rust","permalink":"/blog/tags/rust"},{"inline":true,"label":"performance","permalink":"/blog/tags/performance"},{"inline":true,"label":"crf","permalink":"/blog/tags/crf"},{"inline":true,"label":"nlp","permalink":"/blog/tags/nlp"}],"readingTime":2.67,"hasTruncateMarker":true,"authors":[{"name":"Vu Anh","title":"Creator of Underthesea","url":"https://github.com/rain1024","imageURL":"https://github.com/rain1024.png","key":"rain1024","page":null}],"frontMatter":{"slug":"rewrite-rust-crf-model","title":"Rewriting CRF Model in Rust - 20% Performance Boost","authors":["rain1024"],"tags":["rust","performance","crf","nlp"]},"unlisted":false}')},8453(e,n,r){r.d(n,{R:()=>l,x:()=>d});var i=r(6540);const t={},s=i.createContext(t);function l(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(s.Provider,{value:n},e.children)}},9432(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});var i=r(2413),t=r(4848),s=r(8453);const l={slug:"rewrite-rust-crf-model",title:"Rewriting CRF Model in Rust - 20% Performance Boost",authors:["rain1024"],tags:["rust","performance","crf","nlp"]},d="Rewriting CRF Model in Rust: A 20% Performance Boost",o={authorsImageUrls:[void 0]},a=[{value:"Background",id:"background",level:2},{value:"The Architecture Change",id:"the-architecture-change",level:2},{value:"Before (v9.2.1)",id:"before-v921",level:3},{value:"After (v9.2.5)",id:"after-v925",level:3},{value:"Code Changes",id:"code-changes",level:2},{value:"Benchmark Results",id:"benchmark-results",level:2},{value:"Why Is It Faster?",id:"why-is-it-faster",level:2},{value:"1. Unified Runtime",id:"1-unified-runtime",level:3},{value:"2. Optimized Viterbi Implementation",id:"2-optimized-viterbi-implementation",level:3},{value:"3. Zero-Copy Where Possible",id:"3-zero-copy-where-possible",level:3},{value:"4. Removed Dependency",id:"4-removed-dependency",level:3},{value:"Migration Path",id:"migration-path",level:2},{value:"Model Compatibility",id:"model-compatibility",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"Try It Out",id:"try-it-out",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["In underthesea v9.2.5, we completed the migration from ",(0,t.jsx)(n.code,{children:"python-crfsuite"})," to our native Rust implementation ",(0,t.jsx)(n.code,{children:"underthesea-core"}),". This change resulted in a ",(0,t.jsx)(n.strong,{children:"20% performance improvement"})," across all CRF-based NLP tasks."]}),"\n",(0,t.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,t.jsx)(n.p,{children:"Underthesea uses Conditional Random Fields (CRF) for several core NLP tasks:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Word tokenization"}),"\n",(0,t.jsx)(n.li,{children:"POS tagging"}),"\n",(0,t.jsx)(n.li,{children:"Named Entity Recognition (NER)"}),"\n",(0,t.jsx)(n.li,{children:"Chunking"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Previously, we relied on ",(0,t.jsx)(n.code,{children:"python-crfsuite"}),", a Python wrapper for the CRFsuite C++ library. While functional, this introduced overhead from multiple language boundaries."]}),"\n",(0,t.jsx)(n.h2,{id:"the-architecture-change",children:"The Architecture Change"}),"\n",(0,t.jsx)(n.h3,{id:"before-v921",children:"Before (v9.2.1)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Python                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502    Input     \u2502\u2500\u2500\u2500\u25b6\u2502 CRFFeaturizer\u2502\u2500\u2500\u2500\u25b6\u2502   Python     \u2502  \u2502\n\u2502  \u2502   Tokens     \u2502    \u2502    (Rust)    \u2502    \u2502    List      \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                  \u2502          \u2502\n\u2502                                                  \u25bc          \u2502\n\u2502                                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502                                          \u2502  pycrfsuite  \u2502  \u2502\n\u2502                                          \u2502    (C++)     \u2502  \u2502\n\u2502                                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.p,{children:"The data flow crossed multiple language boundaries:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Python \u2192 Rust (CRFFeaturizer)"}),"\n",(0,t.jsx)(n.li,{children:"Rust \u2192 Python (feature list)"}),"\n",(0,t.jsx)(n.li,{children:"Python \u2192 C++ (pycrfsuite)"}),"\n",(0,t.jsx)(n.li,{children:"C++ \u2192 Python (tags)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"after-v925",children:"After (v9.2.5)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Python                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502    Input     \u2502\u2500\u2500\u2500\u25b6\u2502 CRFFeaturizer\u2502\u2500\u2500\u2500\u25b6\u2502  CRFTagger   \u2502  \u2502\n\u2502  \u2502   Tokens     \u2502    \u2502    (Rust)    \u2502    \u2502    (Rust)    \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                              \u2502                   \u2502          \u2502\n\u2502                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502                               underthesea-core              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now both preprocessing and inference are in Rust within the same module, eliminating the C++ dependency entirely."}),"\n",(0,t.jsx)(n.h2,{id:"code-changes",children:"Code Changes"}),"\n",(0,t.jsx)(n.p,{children:"The change was minimal from the API perspective:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Before:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import pycrfsuite\nfrom underthesea_core import CRFFeaturizer\n\nclass FastCRFSequenceTagger:\n    def load(self, base_path):\n        estimator = pycrfsuite.Tagger()\n        estimator.open(model_path)\n        # ...\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"After:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"from underthesea_core import CRFFeaturizer, CRFTagger\n\nclass FastCRFSequenceTagger:\n    def load(self, base_path):\n        estimator = CRFTagger()\n        estimator.load(model_path)\n        # ...\n"})}),"\n",(0,t.jsx)(n.h2,{id:"benchmark-results",children:"Benchmark Results"}),"\n",(0,t.jsx)(n.p,{children:"We benchmarked both versions on the same hardware with 100 iterations:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Function"}),(0,t.jsx)(n.th,{children:"v9.2.1 (pycrfsuite)"}),(0,t.jsx)(n.th,{children:"v9.2.5 (Rust)"}),(0,t.jsx)(n.th,{children:"Improvement"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"word_tokenize"}),(0,t.jsx)(n.td,{children:"1.45ms"}),(0,t.jsx)(n.td,{children:"1.18ms"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"-19%"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"pos_tag"}),(0,t.jsx)(n.td,{children:"3.58ms"}),(0,t.jsx)(n.td,{children:"2.93ms"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"-18%"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"ner"}),(0,t.jsx)(n.td,{children:"9.61ms"}),(0,t.jsx)(n.td,{children:"8.49ms"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"-12%"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"chunk"}),(0,t.jsx)(n.td,{children:"6.19ms"}),(0,t.jsx)(n.td,{children:"5.65ms"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"-9%"})})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"why-is-it-faster",children:"Why Is It Faster?"}),"\n",(0,t.jsx)(n.h3,{id:"1-unified-runtime",children:"1. Unified Runtime"}),"\n",(0,t.jsxs)(n.p,{children:["Both ",(0,t.jsx)(n.code,{children:"CRFFeaturizer"})," and ",(0,t.jsx)(n.code,{children:"CRFTagger"})," are now in the same Rust module. This allows:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Shared memory management"}),"\n",(0,t.jsx)(n.li,{children:"No intermediate Python object creation"}),"\n",(0,t.jsx)(n.li,{children:"Potential for future optimizations (e.g., fusing operations)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2-optimized-viterbi-implementation",children:"2. Optimized Viterbi Implementation"}),"\n",(0,t.jsx)(n.p,{children:"Our Rust implementation uses pre-allocated vectors and cache-friendly memory layouts:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"fn viterbi(&self, attr_ids: &[Vec<u32>]) -> TaggingResult {\n    let n = attr_ids.len();\n    let num_labels = self.model.num_labels;\n\n    // Pre-allocated score matrix\n    let mut score = vec![vec![f64::NEG_INFINITY; num_labels]; n];\n    let mut back = vec![vec![0u32; num_labels]; n];\n\n    // Cache emission scores per position\n    let emission_t = self.model.emission_scores(&attr_ids[t]);\n\n    // Direct memory access in inner loop\n    for y in 0..num_labels {\n        for y_prev in 0..num_labels {\n            let trans = self.model.get_transition(y_prev as u32, y as u32);\n            // ...\n        }\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-zero-copy-where-possible",children:"3. Zero-Copy Where Possible"}),"\n",(0,t.jsx)(n.p,{children:"PyO3 bindings allow efficient data transfer between Python and Rust without unnecessary copying."}),"\n",(0,t.jsx)(n.h3,{id:"4-removed-dependency",children:"4. Removed Dependency"}),"\n",(0,t.jsxs)(n.p,{children:["Removing ",(0,t.jsx)(n.code,{children:"python-crfsuite"})," also means:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Simpler installation (no C++ compiler needed)"}),"\n",(0,t.jsx)(n.li,{children:"Smaller package size"}),"\n",(0,t.jsx)(n.li,{children:"Fewer potential compatibility issues"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"migration-path",children:"Migration Path"}),"\n",(0,t.jsx)(n.p,{children:"The migration was done incrementally across 4 releases:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Version"}),(0,t.jsx)(n.th,{children:"Changes"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"v9.2.2"}),(0,t.jsx)(n.td,{children:"word_tokenize migrated"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"v9.2.3"}),(0,t.jsx)(n.td,{children:"pos_tag, ner, chunking migrated"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"v9.2.4"}),(0,t.jsx)(n.td,{children:"CRFTrainer migrated, removed unused files"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"v9.2.5"}),(0,t.jsx)(n.td,{children:"Removed python-crfsuite dependency"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"model-compatibility",children:"Model Compatibility"}),"\n",(0,t.jsxs)(n.p,{children:["The Rust implementation can load existing ",(0,t.jsx)(n.code,{children:".crfsuite"})," model files trained by python-crfsuite. No retraining is required."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Works with both old and new models\nfrom underthesea import word_tokenize\nword_tokenize(\"H\xe0 N\u1ed9i l\xe0 th\u1ee7 \u0111\xf4 c\u1ee7a Vi\u1ec7t Nam\")\n# ['H\xe0 N\u1ed9i', 'l\xe0', 'th\u1ee7 \u0111\xf4', 'c\u1ee7a', 'Vi\u1ec7t Nam']\n"})}),"\n",(0,t.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"By rewriting our CRF inference in Rust and unifying the preprocessing pipeline, we achieved:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"20% faster inference"})," across all CRF-based tasks"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Simpler dependency tree"})," (no python-crfsuite)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Better maintainability"})," with a single codebase"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The full implementation is available in ",(0,t.jsx)(n.a,{href:"https://github.com/undertheseanlp/underthesea/tree/main/extensions/underthesea_core",children:"underthesea-core"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"try-it-out",children:"Try It Out"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"pip install underthesea==9.2.5\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from underthesea import word_tokenize, pos_tag, ner, chunk\n\nword_tokenize("Vi\u1ec7t Nam")  # 20% faster!\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);